> 這個功能我想大家應該都不陌生，許多平臺都會強制更新密碼有這樣的功能，只是每個平臺背後實作的方式可能會有所不同，今天就跟大家分享在[線上計畫書專案](https://gitlab-iso3.iiidevops.org/root/proposal-editor)中的做法。

## User Flow

使用者註冊帳號之後，從他自己的信箱拿到一組密碼，這時候他回到我們的平臺上面登入，登入進來之後，系統就會強制使用者更新他的密碼。

---

## 要實現這個 flow，前後端都做了什麼事情?

使用者登入進來之後，系統會開始 fetch api，比如說像是去拿使用者資料之類的或是其他需要在登入後就拿到的資料，不管這時候打了哪一支 API，後端會去檢查說今天這個使用者是不是已經有更換過他的密碼，如果使用者已經把預設密碼改掉了，那後端就會照常 request 前端請求的資料，如果使用者沒有把預設密碼改掉，後端就會 request 401 錯誤，並且在錯誤訊息中給一串字串，前端就可以根據這個字串去做相對應的處理。

![](./photo/Pasted%20image%2020230317114939.png)

可以看到上面這張圖就是登入之後的 network，第一個 request 是處理登入的，第二個 request 則是請求其他資料的。

![](./photo/Pasted%20image%2020230317115009.png)

然後第二個 request 裡面的錯誤訊息會帶給前端這個字串: “Update password required”，這樣前端就知道這個錯誤是來自尚未更改預設密碼了。

---

## request.js

這時候我們可以在處理系統錯誤訊息的 request.js 中攔截到這個錯誤。

```jsx
service.intercetors.response.use(
	response => {
		...
	},
	async error => {
		...
		if {
			...
		} else if (data.detail && (typeof data.detail === 'string')) {
			res_msg.push(handleRegularError({ msg: data.detail }))
		} else {
			...
		}
		for (const id in res_msg) {
      Message({
        message: res_msg[id],
        type: 'error',
        duration: 6000
      })
    }
    return Promise.reject(error)
	}
)
```

最後把這個字串轉換成支援 i18n 的訊息，並且讓畫面跳轉到重新設置密碼的頁面。

```jsx
const handleRegularError = (data) => {
	let res_msg = ''
	switch (data.msg) {
		...
		case 'Update password required':
      res_msg = i18n.t('Notify.ChangePasswordError')
      router.push({ name: 'PersonalInformation' }) // force updating password
      break
		
	}
}
```

做到這邊就完成強制更新密碼的功能了，最後總結一下如果要實作這個功能，首先是要請後端先幫忙調整 API，讓 API 有辦法辨識使用者有沒有更換過預設密碼，再來才能依據後端給的 error detail 在前端進行處理。

tag: #Vue 